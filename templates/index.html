<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Alidux â€” Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ğ´Ğ¾Ğ¼</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
/* â”€â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:       #f7f9ff;
  --surface:  #ffffff;
  --border:   #e4eaf8;
  --text:     #0f172a;
  --muted:    #64748b;
  --blue:     #2563eb;
  --blue-d:   #1d4ed8;
  --blue-l:   #3b82f6;
  --blue-bg:  #eff6ff;
  --green:    #16a34a;
  --green-l:  #22c55e;
  --red:      #dc2626;
  --red-l:    #ef4444;
  --orange:   #f97316;
  --yellow:   #eab308;
  --radius:   18px;
  --shadow-sm: 0 1px 6px rgba(37,99,235,0.06);
  --shadow:    0 4px 20px rgba(37,99,235,0.10);
  --shadow-lg: 0 12px 40px rgba(37,99,235,0.16);
}

html { scroll-behavior: smooth; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€â”€ Notification Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast-container {
  position: fixed; top: 80px; right: 16px; z-index: 9999;
  display: flex; flex-direction: column; gap: 10px; max-width: 360px;
  pointer-events: none;
}
.toast {
  background: #fff; border-left: 4px solid var(--blue);
  border-radius: 12px; padding: 14px 16px;
  box-shadow: var(--shadow-lg);
  font-size: 13px; font-weight: 600; color: var(--text);
  display: flex; align-items: flex-start; gap: 12px;
  pointer-events: all; cursor: pointer;
  animation: slideIn .3s ease;
  transition: opacity .3s;
}
.toast.alarm { border-color: var(--red); }
.toast.warn  { border-color: var(--orange); }
.toast.ok    { border-color: var(--green); }
.toast-icon  { font-size: 20px; flex-shrink: 0; margin-top: 1px; }
.toast-body  { flex: 1; }
.toast-title { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
.toast-msg   { font-weight: 500; color: var(--muted); font-size: 12px; }
@keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border); height: 64px;
  padding: 0 clamp(16px, 4vw, 40px);
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 1px 16px rgba(37,99,235,0.06);
}
.brand { display: flex; align-items: center; gap: 10px; text-decoration: none; }
.brand img { width: 32px; height: 32px; object-fit: contain; }
.brand-name {
  font-size: 20px; font-weight: 800; letter-spacing: -.5px;
  background: linear-gradient(135deg, #1d4ed8, #3b82f6);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-right { display: flex; align-items: center; gap: 10px; }
.user-chip {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 12px; background: var(--blue-bg);
  border: 1px solid var(--border); border-radius: 999px;
}
.user-avatar {
  width: 26px; height: 26px; border-radius: 50%;
  background: linear-gradient(135deg, #2563eb, #60a5fa);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; color: #fff; flex-shrink: 0;
}
.user-name { font-size: 13px; font-weight: 600; color: var(--blue); }
.logout-btn {
  padding: 7px 14px; border-radius: 10px; background: transparent;
  border: 1.5px solid var(--border); color: var(--muted);
  font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s;
  font-family: inherit;
}
.logout-btn:hover { border-color: var(--red-l); color: var(--red); background: #fef2f2; }
@media(max-width: 480px) {
  .user-name { display: none; }
  .logout-btn { padding: 7px 10px; }
}

/* â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main { padding: clamp(20px, 4vw, 40px) clamp(16px, 4vw, 40px); max-width: 1300px; margin: 0 auto; }

/* â”€â”€â”€ Section Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-hdr {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
}
.section-title h2 { font-size: clamp(18px, 3vw, 24px); font-weight: 800; }
.section-title p  { font-size: 13px; color: var(--muted); margin-top: 3px; }

.add-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 11px 20px;
  background: linear-gradient(135deg, var(--blue), var(--blue-d));
  border: none; border-radius: 13px;
  color: #fff; font-size: 14px; font-weight: 700;
  cursor: pointer; transition: all .2s; font-family: inherit;
  box-shadow: 0 4px 14px rgba(37,99,235,0.35); white-space: nowrap;
}
.add-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 22px rgba(37,99,235,0.45); }
.add-btn:active { transform: none; }

/* â”€â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 14px; margin-bottom: 28px;
}
.stat-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 18px 20px;
  box-shadow: var(--shadow-sm);
}
.stat-label { font-size: 11px; color: var(--muted); font-weight: 700;
  text-transform: uppercase; letter-spacing: .6px; }
.stat-val { font-size: 26px; font-weight: 800; margin-top: 6px; color: var(--blue); }

/* â”€â”€â”€ Device Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 16px;
}
.device-card {
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: var(--radius); padding: 24px 18px 20px;
  cursor: pointer; transition: all .25s; text-align: center;
  position: relative; box-shadow: var(--shadow-sm); user-select: none;
}
.device-card:hover { transform: translateY(-4px); border-color: var(--blue-l); box-shadow: var(--shadow-lg); }
.device-card.offline-card { opacity: .7; cursor: default; }
.device-card.offline-card:hover { transform: none; border-color: var(--border); box-shadow: var(--shadow-sm); }
.device-card.leak-active  { border-color: var(--red-l) !important; animation: pulse-red 2s infinite; }
.device-card.leak-active:hover { transform: none; }
@keyframes pulse-red { 0%,100%{box-shadow:0 2px 14px rgba(220,38,38,0)} 50%{box-shadow:0 4px 28px rgba(220,38,38,.28)} }

.device-icon-wrap {
  width: 72px; height: 72px; margin: 0 auto 14px;
  border-radius: 18px; background: linear-gradient(135deg, #eff6ff, #dbeafe);
  display: flex; align-items: center; justify-content: center;
  font-size: 36px; transition: transform .25s;
}
.device-card:hover .device-icon-wrap { transform: scale(1.08); }
.device-card.leak-active .device-icon-wrap { background: linear-gradient(135deg, #fef2f2, #fee2e2); }
.device-card.offline-card .device-icon-wrap { background: #f1f5f9; filter: grayscale(.5); }

.device-name {
  font-size: 14px; font-weight: 700; color: var(--text);
  margin-bottom: 10px; word-break: break-word; line-height: 1.3;
}
.status-pill {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 4px 11px; border-radius: 999px; font-size: 11px; font-weight: 700;
}
.pill-online  { background: #f0fdf4; color: var(--green);  border: 1px solid #bbf7d0; }
.pill-leak    { background: #fef2f2; color: var(--red);    border: 1px solid #fecaca; }
.pill-offline { background: #f8fafc; color: var(--muted);  border: 1px solid #e2e8f0; }

.status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.dot-online  { background: var(--green-l); box-shadow: 0 0 5px var(--green-l); }
.dot-leak    { background: var(--red-l);   animation: blink 1s infinite; }
.dot-offline { background: #cbd5e1; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.25} }

.role-badge {
  position: absolute; top: 10px; right: 10px;
  font-size: 10px; font-weight: 700; padding: 2px 7px;
  border-radius: 999px; background: #f0f9ff; color: var(--blue);
  border: 1px solid var(--border);
}
.role-badge.viewer { background: #fafafa; color: var(--muted); }

.empty {
  grid-column: 1/-1; background: var(--surface);
  border: 2px dashed var(--border); border-radius: 20px;
  padding: clamp(50px, 8vw, 80px) 20px; text-align: center;
}
.empty-icon { font-size: 56px; display: block; margin-bottom: 14px; opacity: .4; }
.empty h3   { font-size: 17px; font-weight: 700; color: var(--text); }
.empty p    { font-size: 13px; color: var(--muted); margin-top: 6px; }

/* â”€â”€â”€ Overlay & Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
  position: fixed; inset: 0; background: rgba(15,23,42,0.5);
  backdrop-filter: blur(3px); z-index: 200;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
.overlay.open { opacity: 1; pointer-events: all; }

.panel {
  position: fixed; top: 0; right: 0; height: 100%;
  width: min(460px, 100vw);
  background: #fff; border-left: 1px solid var(--border);
  z-index: 201; transform: translateX(100%);
  transition: transform .32s cubic-bezier(.4,0,.2,1);
  display: flex; flex-direction: column;
  box-shadow: -8px 0 50px rgba(37,99,235,0.12);
}
.panel.open { transform: translateX(0); }

.panel-hdr {
  padding: 20px 22px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 14px;
  background: linear-gradient(135deg, #f0f6ff, #fff);
  flex-shrink: 0;
}
.panel-icon-wrap {
  width: 52px; height: 52px; border-radius: 16px;
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; flex-shrink: 0;
}
.panel-title { font-size: 16px; font-weight: 800; line-height: 1.2; }
.panel-sub   { font-size: 11px; color: var(--muted); margin-top: 3px; }
.panel-close {
  width: 34px; height: 34px; border-radius: 10px;
  background: #f1f5f9; border: none; color: var(--muted);
  font-size: 18px; cursor: pointer; flex-shrink: 0; margin-left: auto;
  transition: all .2s;
}
.panel-close:hover { background: #fee2e2; color: var(--red); }

.panel-offline-msg {
  margin: 20px 22px; padding: 16px 18px;
  background: #f8fafc; border: 1.5px solid #e2e8f0;
  border-radius: 14px; text-align: center;
  font-size: 14px; color: var(--muted); font-weight: 600;
}
.panel-offline-msg .big { font-size: 36px; display: block; margin-bottom: 8px; }

.panel-body { padding: 20px 22px; overflow-y: auto; flex: 1; }

/* Sections inside panel */
.sec-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
  color: var(--muted); font-weight: 700; margin-bottom: 10px; margin-top: 18px;
}
.sec-label:first-child { margin-top: 0; }
.ic {
  background: #f8faff; border: 1.5px solid var(--border);
  border-radius: 14px; padding: 16px 18px; margin-bottom: 12px;
}
.bstat { display: flex; align-items: center; gap: 12px; font-size: 15px; font-weight: 700; }
.last-seen { font-size: 12px; color: var(--muted); margin-top: 6px; }

/* Battery */
.battery-bar-bg  { height: 7px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 10px; }
.battery-bar-fill { height: 100%; border-radius: 4px; transition: width .5s, background .5s; }
.battery-label   { font-size: 12px; color: var(--muted); margin-top: 4px; }

/* Rename */
.rename-btn {
  background: none; border: none; cursor: pointer; color: var(--muted);
  font-size: 13px; padding: 2px 5px; border-radius: 6px; transition: all .2s;
}
.rename-btn:hover { background: var(--blue-bg); color: var(--blue); }

/* Valve button */
.valve-btn {
  width: 100%; padding: 13px; border: none; border-radius: 12px;
  font-size: 14px; font-weight: 700; cursor: pointer; color: #fff;
  margin-bottom: 14px; transition: opacity .2s, transform .15s;
  font-family: inherit; position: relative;
}
.valve-btn:hover { opacity: .88; }
.valve-btn:active { transform: scale(.98); }
.valve-btn:disabled { opacity: .5; cursor: not-allowed; }
.v-open  { background: linear-gradient(135deg, var(--blue), var(--blue-d)); }
.v-close { background: linear-gradient(135deg, var(--red), #b91c1c); }

/* Slider */
.slider-row {
  display: flex; align-items: center; gap: 10px; margin-bottom: 4px;
}
.slider-row input[type=range] {
  flex: 1; accent-color: var(--blue); cursor: pointer; height: 6px;
}
.slider-val {
  min-width: 44px; text-align: center; font-size: 13px; font-weight: 700;
  background: var(--blue-bg); border: 1px solid var(--border);
  border-radius: 8px; padding: 4px 7px; color: var(--blue);
}
.slider-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); }

/* Logs */
.log-item {
  display: flex; flex-direction: column; padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.log-item:last-child { border-bottom: none; }
.log-time { font-size: 10px; color: var(--muted); }
.log-msg  { font-size: 13px; font-weight: 600; color: var(--text); margin-top: 2px; }
.log-leak .log-msg { color: var(--red); }
.log-dry  .log-msg { color: var(--green); }
.log-valve .log-msg { color: var(--blue); }
.log-low_battery .log-msg { color: var(--orange); }
.log-shared .log-msg { color: var(--muted); }

/* Share panel */
.share-user-row {
  display: flex; align-items: center; gap: 10px; padding: 10px 12px;
  background: #f8faff; border: 1px solid var(--border);
  border-radius: 11px; margin-bottom: 8px;
}
.share-user-avatar {
  width: 30px; height: 30px; border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6, #60a5fa);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0;
}
.share-user-name { flex: 1; font-size: 13px; font-weight: 700; }
.share-role-badge {
  font-size: 11px; font-weight: 700; padding: 3px 9px;
  border-radius: 999px; border: 1px solid;
}
.role-full   { color: var(--blue); border-color: #bfdbfe; background: var(--blue-bg); }
.role-viewer { color: var(--muted); border-color: var(--border); background: #f8fafc; }
.revoke-btn {
  background: none; border: none; cursor: pointer; color: var(--muted);
  font-size: 16px; padding: 2px; transition: color .2s;
}
.revoke-btn:hover { color: var(--red); }

/* Action buttons */
.action-btn {
  width: 100%; padding: 12px; border-radius: 12px;
  font-size: 13px; font-weight: 700; cursor: pointer;
  font-family: inherit; transition: all .2s; margin-bottom: 10px;
}
.action-outline {
  background: none; border: 1.5px solid var(--border); color: var(--muted);
}
.action-outline:hover { border-color: var(--blue-l); color: var(--blue); background: var(--blue-bg); }
.action-red {
  background: none; border: 1.5px solid #fecaca; color: var(--red);
}
.action-red:hover { background: #fef2f2; }

/* Code display */
.code-display {
  display: flex; justify-content: center; align-items: center; gap: 8px;
  margin: 16px 0;
}
.code-digit {
  width: 52px; height: 64px; border-radius: 14px;
  background: var(--blue-bg); border: 2px solid var(--blue-l);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; font-weight: 900; color: var(--blue);
  font-family: 'Courier New', monospace;
  box-shadow: 0 4px 14px rgba(37,99,235,0.15);
}
.code-timer {
  text-align: center; font-size: 12px; color: var(--muted); font-weight: 600;
  margin-top: 8px;
}
.code-timer.expiring { color: var(--red); }

/* Spinner */
.spinner {
  display: inline-block; width: 14px; height: 14px;
  border: 2px solid rgba(255,255,255,.35); border-top-color: #fff;
  border-radius: 50%; animation: spin .6s linear infinite;
  vertical-align: middle; margin-right: 7px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Chip ID */
.chip-block {
  font-family: monospace; font-size: 12px; color: var(--blue);
  background: var(--blue-bg); padding: 4px 9px; border-radius: 7px;
  border: 1px dashed var(--blue-l);
}

/* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 600px) {
  .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
  .stats { grid-template-columns: repeat(2, 1fr); }
  .stat-val { font-size: 22px; }
  .panel-hdr { padding: 16px; }
  .panel-body { padding: 14px 16px; }
  .panel-offline-msg { margin: 14px 16px; }
}
</style>
</head>
<body>

<!-- Toast container for alerts/notifications -->
<div id="toast-container"></div>

<header>
  <a class="brand" href="/">
    <img src="https://alidux.by/favicon/favicon.svg" alt="Alidux" onerror="this.style.display='none'">
    <span class="brand-name">Alidux</span>
  </a>
  <div class="header-right">
    <div class="user-chip">
      <div class="user-avatar" id="user-avatar">?</div>
      <span class="user-name">{{ username }}</span>
    </div>
    <form action="/logout" method="post">
      <button type="submit" class="logout-btn">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </form>
  </div>
</header>

<main>
  <div class="section-hdr">
    <div class="section-title">
      <h2>ĞœĞ¾Ğ¸ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°</h2>
      <p>Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑƒĞ¼Ğ½Ñ‹Ğ¼ Ğ´Ğ¾Ğ¼Ğ¾Ğ¼</p>
    </div>
    <button class="add-btn" onclick="showAdd()">ï¼‹ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">Ğ’ÑĞµĞ³Ğ¾</div>
      <div class="stat-val" id="stat-total">â€”</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ĞĞ½Ğ»Ğ°Ğ¹Ğ½</div>
      <div class="stat-val" style="color:var(--green)" id="stat-online">â€”</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ĞŸÑ€Ğ¾Ñ‚ĞµÑ‡ĞºĞ¸</div>
      <div class="stat-val" style="color:var(--red)" id="stat-leaks">â€”</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ĞÑ„Ğ»Ğ°Ğ¹Ğ½</div>
      <div class="stat-val" style="color:var(--muted)" id="stat-offline">â€”</div>
    </div>
  </div>

  <div class="grid" id="grid"></div>
</main>

<!-- Overlay -->
<div class="overlay" id="overlay" onclick="closePanel()"></div>

<!-- Device panel -->
<div class="panel" id="panel">
  <div class="panel-hdr">
    <div class="panel-icon-wrap" id="p-icon">ğŸ </div>
    <div style="flex:1; min-width:0;">
      <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
        <div class="panel-title" id="p-title"></div>
        <button class="rename-btn" id="p-rename-btn" onclick="doRename()" title="ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ">âœï¸</button>
      </div>
      <div class="panel-sub">
        Chip: <span id="p-chip" class="chip-block"></span>
        <span id="p-role-label" style="margin-left:6px; font-size:10px; color:var(--muted);"></span>
      </div>
    </div>
    <button class="panel-close" onclick="closePanel()">âœ•</button>
  </div>

  <!-- Shown when offline -->
  <div id="panel-offline" class="panel-offline-msg" style="display:none;">
    <span class="big">ğŸ“¡</span>
    Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½.<br>
    <span style="font-size:12px; font-weight:500;">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ° ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑÑ Ğº ÑĞµÑ‚Ğ¸.</span>
    <div id="p-lastseen-offline" style="font-size:11px; margin-top:8px; opacity:.7;"></div>
  </div>

  <!-- Online content -->
  <div class="panel-body" id="panel-online-body">

    <div class="sec-label">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°</div>
    <div class="ic">
      <div class="bstat">
        <div class="status-dot" id="p-bdot"></div>
        <span id="p-status-txt"></span>
      </div>
      <div class="last-seen" id="p-lastseen"></div>
      <div style="margin-top:12px;">
        <div class="battery-bar-bg">
          <div class="battery-bar-fill" id="p-battery-bar"></div>
        </div>
        <div class="battery-label" id="p-battery-label"></div>
      </div>
    </div>

    <div id="valve-section">
      <div class="sec-label">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºÑ€Ğ°Ğ½Ğ¾Ğ¼</div>
      <div class="ic">
        <button class="valve-btn" id="p-valve-btn" onclick="doValve()">â€”</button>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="font-size:12px; color:var(--muted); font-weight:600;">ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ĞºÑ€Ğ°Ğ½Ğ°</div>
          <div class="slider-val" id="p-slider-val">100</div>
        </div>
        <div class="slider-row">
          <span style="font-size:11px; color:var(--muted);">0%</span>
          <input type="range" id="p-slider" min="0" max="100" step="5"
                 oninput="onSliderInput(this.value)"
                 onchange="doSlider(this.value)">
          <span style="font-size:11px; color:var(--muted);">100%</span>
        </div>
      </div>
    </div>

    <div id="log-section">
      <div class="sec-label" style="display:flex; justify-content:space-between; align-items:center;">
        <span>Ğ–ÑƒÑ€Ğ½Ğ°Ğ» ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹</span>
        <button onclick="loadLogs(selId)"
          style="background:none;border:none;color:var(--blue);font-size:12px;cursor:pointer;font-weight:600;">
          â†» ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
        </button>
      </div>
      <div class="ic" id="p-logs" style="max-height:220px; overflow-y:auto; padding:12px 14px;"></div>
    </div>

    <!-- Actions -->
    <div id="owner-actions" style="margin-top:6px;">
      <div class="sec-label">ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿</div>
      <button class="action-btn action-outline" onclick="showShares()">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿</button>
      <div class="sec-label" style="margin-top:4px;"></div>
      <button class="action-btn action-red" onclick="doDelete()">ğŸ—‘ ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾</button>
    </div>
    <div id="viewer-notice" style="display:none; margin-top:10px; padding:12px 14px;
      background:#fafafa; border-radius:12px; font-size:12px; color:var(--muted);
      border:1px solid var(--border); text-align:center;">
      ğŸ‘ Ğ£ Ğ²Ğ°Ñ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° â€” ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾
    </div>

  </div>
</div>

<script>
/* â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let devices = [];
let selId   = null;
const username = '{{ username }}';
document.getElementById('user-avatar').textContent = username[0]?.toUpperCase() || '?';

// Track leak state for notifications
const leakNotified = new Set();

/* â”€â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function requestNotifPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}
requestNotifPermission();

function showToast(type, title, msg, duration = 6000) {
  const icons = { alarm: 'ğŸš¨', warn: 'âš ï¸', ok: 'âœ…', info: 'â„¹ï¸' };
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <div class="toast-icon">${icons[type] || 'â„¹ï¸'}</div>
    <div class="toast-body">
      <div class="toast-title">${escHtml(title)}</div>
      <div class="toast-msg">${escHtml(msg)}</div>
    </div>`;
  toast.onclick = () => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); };
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, duration);
}

function sendBrowserNotif(title, body) {
  if ('Notification' in window && Notification.permission === 'granted') {
    try { new Notification(title, { body, icon: 'https://alidux.by/favicon/favicon.svg' }); } catch {}
  }
}

/* â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtDate(iso) {
  if (!iso) return '';
  const d = new Date(iso.endsWith('Z') ? iso : iso + 'Z');
  return d.toLocaleString('ru-RU');
}
function batteryColor(pct) {
  if (pct > 50) return 'var(--green)';
  if (pct > 20) return 'var(--orange)';
  return 'var(--red)';
}
function deviceIcon(d) {
  if (d.leak)       return 'ğŸ’¦';
  if (!d.online)    return 'ğŸ“´';
  const types = { water_sensor: 'ğŸš¿', thermostat: 'ğŸŒ¡ï¸', light: 'ğŸ’¡', plug: 'ğŸ”Œ', camera: 'ğŸ“·' };
  return types[d.device_type] || 'ğŸ ';
}

/* â”€â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function load() {
  try {
    const r = await fetch('/api/devices');
    if (r.status === 401) { location.href = '/login'; return; }
    if (!r.ok) return;
    const newDevices = await r.json();

    // Check for new leaks â†’ notify
    for (const d of newDevices) {
      if (d.leak && !leakNotified.has(d.id)) {
        leakNotified.add(d.id);
        showToast('alarm', 'âš ï¸ ĞŸÑ€Ğ¾Ñ‚ĞµÑ‡ĞºĞ°!', `Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº Â«${d.name}Â» Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ» Ğ¿Ñ€Ğ¾Ñ‚ĞµÑ‡ĞºÑƒ`);
        sendBrowserNotif('âš ï¸ ĞŸÑ€Ğ¾Ñ‚ĞµÑ‡ĞºĞ° Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ°!', `Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº Â«${d.name}Â» ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»`);
      }
      if (!d.leak && leakNotified.has(d.id)) {
        leakNotified.delete(d.id);
        showToast('ok', 'ĞŸÑ€Ğ¾Ñ‚ĞµÑ‡ĞºĞ° ÑƒÑÑ‚Ñ€Ğ°Ğ½ĞµĞ½Ğ°', `Ğ”Ğ°Ñ‚Ñ‡Ğ¸Ğº Â«${d.name}Â» ÑÑƒÑ…`);
      }
      if (d.battery !== undefined) {
        const prev = devices.find(x => x.id === d.id);
        if (prev && prev.battery > 20 && d.battery <= 20) {
          showToast('warn', 'ĞĞ¸Ğ·ĞºĞ¸Ğ¹ Ğ·Ğ°Ñ€ÑĞ´', `Â«${d.name}Â»: Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµÑ ${d.battery}%`);
        }
      }
    }

    devices = newDevices;

    const total   = devices.length;
    const online  = devices.filter(d => d.online).length;
    const leaks   = devices.filter(d => d.leak).length;
    const offline = devices.filter(d => !d.online).length;
    document.getElementById('stat-total').textContent   = total;
    document.getElementById('stat-online').textContent  = online;
    document.getElementById('stat-leaks').textContent   = leaks;
    document.getElementById('stat-offline').textContent = offline;

    renderGrid();

    if (selId) {
      const d = devices.find(x => x.id === selId);
      if (d) updatePanelData(d);
    }
  } catch (e) {
    console.error('load error:', e);
  }
}

/* â”€â”€â”€ Grid rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderGrid() {
  const g = document.getElementById('grid');
  if (!devices.length) {
    g.innerHTML = `
      <div class="empty">
        <span class="empty-icon">ğŸ </span>
        <h3>Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚</h3>
        <p>Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒÂ»</p>
      </div>`;
    return;
  }
  g.innerHTML = devices.map(d => {
    const cls  = d.leak ? 'leak-active' : (!d.online ? 'offline-card' : '');
    const pill = d.leak ? 'pill-leak' : (d.online ? 'pill-online' : 'pill-offline');
    const dot  = d.leak ? 'dot-leak'  : (d.online ? 'dot-online'  : 'dot-offline');
    const txt  = d.leak ? 'ĞŸÑ€Ğ¾Ñ‚ĞµÑ‡ĞºĞ°'  : (d.online ? 'ĞĞ½Ğ»Ğ°Ğ¹Ğ½'      : 'ĞÑ„Ğ»Ğ°Ğ¹Ğ½');
    const roleTag = d.role !== 'owner'
      ? `<div class="role-badge viewer">ğŸ‘ ${d.role === 'viewer' ? 'ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€' : 'ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹'}</div>` : '';
    return `
      <div class="device-card ${cls}" onclick="openPanel(${d.id})">
        ${roleTag}
        <div class="device-icon-wrap">${deviceIcon(d)}</div>
        <div class="device-name">${escHtml(d.name)}</div>
        <div class="status-pill ${pill}">
          <span class="status-dot ${dot}"></span>${txt}
        </div>
      </div>`;
  }).join('');
}

/* â”€â”€â”€ Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function openPanel(id) {
  selId = id;
  const d = devices.find(x => x.id === id);
  if (!d) return;

  document.getElementById('overlay').classList.add('open');
  document.getElementById('panel').classList.add('open');
  updatePanelData(d);

  if (d.online) {
    document.getElementById('p-logs').innerHTML =
      '<div style="color:var(--muted);font-size:12px;padding:4px 0">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ°...</div>';
    await loadLogs(id);
  }
}

function closePanel() {
  selId = null;
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('panel').classList.remove('open');
}

function updatePanelData(d) {
  document.getElementById('p-title').textContent = d.name;
  document.getElementById('p-chip').textContent  = d.chip_id;
  document.getElementById('p-icon').textContent  = deviceIcon(d);

  const roleLabels = { owner: 'ğŸ‘‘ Ğ’Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†', full: 'âœï¸ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿', viewer: 'ğŸ‘ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€' };
  document.getElementById('p-role-label').textContent = roleLabels[d.role] || '';

  const isOwner = d.role === 'owner';
  const canControl = d.role !== 'viewer';

  // Offline handling
  const panelOffline = document.getElementById('panel-offline');
  const panelBody    = document.getElementById('panel-online-body');

  if (!d.online) {
    panelOffline.style.display = '';
    panelBody.style.display    = 'none';
    document.getElementById('p-lastseen-offline').textContent =
      d.last_seen ? 'ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´: ' + fmtDate(d.last_seen) : 'Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµÑ‚';
    document.getElementById('p-rename-btn').style.display = isOwner ? '' : 'none';
    return;
  }

  panelOffline.style.display = 'none';
  panelBody.style.display    = '';

  // Status dot
  const bdot = document.getElementById('p-bdot');
  bdot.className = 'status-dot ' + (d.leak ? 'dot-leak' : 'dot-online');
  document.getElementById('p-status-txt').textContent =
    d.leak ? 'âš ï¸ ĞŸÑ€Ğ¾Ñ‚ĞµÑ‡ĞºĞ° Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ°!' : 'âœ… ĞĞ° ÑĞ²ÑĞ·Ğ¸';
  document.getElementById('p-lastseen').textContent =
    d.last_seen ? 'ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ' + fmtDate(d.last_seen) : '';

  // Battery
  const pct = (d.battery !== undefined && d.battery !== null) ? d.battery : 0;
  const vlt = d.voltage ? `${d.voltage}V` : '--V';

  document.getElementById('p-battery-bar').style.width      = pct + '%';
  document.getElementById('p-battery-bar').style.background = batteryColor(pct);
  document.getElementById('p-battery-label').textContent    = `Ğ—Ğ°Ñ€ÑĞ´: ${pct}% (${vlt})`;

  // Valve button
  const vb = document.getElementById('p-valve-btn');
  vb.disabled  = !canControl;
  vb.className = 'valve-btn ' + (d.valve_open ? 'v-close' : 'v-open');
  vb.textContent = d.valve_open ? 'ğŸ”’ Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ ĞºÑ€Ğ°Ğ½' : 'ğŸš° ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ĞºÑ€Ğ°Ğ½';

  // Slider â€” only update if not being dragged
  const slider = document.getElementById('p-slider');
  if (document.activeElement !== slider) {
    slider.value = d.valve_percent;
    document.getElementById('p-slider-val').textContent = d.valve_percent;
  }
  slider.disabled = !canControl;

  // Show/hide sections
  document.getElementById('valve-section').style.display =
    d.device_type === 'water_sensor' ? '' : 'none';
  document.getElementById('owner-actions').style.display  = isOwner ? '' : 'none';
  document.getElementById('viewer-notice').style.display  = !canControl ? '' : 'none';
  document.getElementById('p-rename-btn').style.display   = (isOwner || canControl) ? '' : 'none';
}

/* â”€â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadLogs(id) {
  try {
    const r = await fetch(`/api/devices/${id}/logs`);
    if (!r.ok) return;
    const logs = await r.json();

    const icons = { leak: 'ğŸ’¦', dry: 'âœ…', valve: 'ğŸš°', claimed: 'ğŸ”—', registered: 'ğŸ”Œ',
                    low_battery: 'ğŸ”‹', shared: 'ğŸ‘¥' };

    const html = logs.map(l => {
      const icon = icons[l.event] || 'â„¹ï¸';
      const cls  = l.event;
      return `<div class="log-item log-${escHtml(cls)}">
        <div class="log-time">${escHtml(fmtDate(l.time))}</div>
        <div class="log-msg">${icon} ${escHtml(l.msg || l.event)}</div>
      </div>`;
    }).join('');

    document.getElementById('p-logs').innerHTML =
      html || '<div style="color:var(--muted);font-size:12px;padding:4px 0">Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ğ¿ÑƒÑÑ‚</div>';
  } catch {}
}

/* â”€â”€â”€ Valve actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doValve() {
  const d = devices.find(x => x.id === selId);
  if (!d) return;

  const newState = !d.valve_open;
  const btn = document.getElementById('p-valve-btn');
  const oldText = btn.textContent;

  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> ${newState ? 'ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°Ñ...' : 'Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°Ñ...'}`;

  try {
    const r = await fetch(`/api/devices/${selId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ valve_open: newState }),
    });

    if (r.ok) {
      const result = await r.json();
      d.valve_open = result.valve_open;
      d.valve_percent = result.valve_percent;
      updatePanelData(d);
      showToast('ok', 'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾', newState ? 'ĞšÑ€Ğ°Ğ½ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ' : 'ĞšÑ€Ğ°Ğ½ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ');
    } else {
      showToast('warn', 'ĞÑˆĞ¸Ğ±ĞºĞ°', 'Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ğ» ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ');
    }
  } catch (e) {
    showToast('warn', 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸', 'ĞĞµÑ‚ ÑĞ²ÑĞ·Ğ¸ Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼');
  } finally {
    btn.disabled = false;
  }
}

function onSliderInput(v) {
  document.getElementById('p-slider-val').textContent = v;
}

async function doSlider(v) {
  const val = parseInt(v);
  document.getElementById('p-slider-val').textContent = val;
  try {
    const r = await fetch(`/api/devices/${selId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ valve_percent: val }),
    });
    if (r.ok) {
      const result = await r.json();
      const d = devices.find(x => x.id === selId);
      if (d) {
        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°
        d.valve_open = result.valve_open;
        d.valve_percent = result.valve_percent;
        updatePanelData(d); // ĞŸĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ
      }
      showToast('ok', 'ĞŸĞ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾', `Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ${val}%`);
    }
  } catch (e) {
    showToast('warn', 'ĞÑˆĞ¸Ğ±ĞºĞ°', 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ');
  }
}

/* â”€â”€â”€ Rename â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doRename() {
  const d = devices.find(x => x.id === selId);
  if (!d) return;
  const { value } = await Swal.fire({
    title: 'ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾',
    input: 'text', inputValue: d.name,
    inputPlaceholder: 'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°',
    showCancelButton: true, confirmButtonText: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ', cancelButtonText: 'ĞÑ‚Ğ¼ĞµĞ½Ğ°',
    inputValidator: v => !v.trim() && 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ',
  });
  if (!value) return;
  const r = await fetch(`/api/devices/${selId}`, {
    method: 'PATCH', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: value.trim() }),
  });
  if (r.ok) await load();
}

/* â”€â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doDelete() {
  const { isConfirmed } = await Swal.fire({
    title: 'ĞÑ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾?',
    text: 'Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ¸Ğ· Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°. Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ° Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒÑ‚ĞµÑ€ÑĞ½Ñ‹.',
    icon: 'warning', showCancelButton: true,
    confirmButtonText: 'Ğ”Ğ°, Ğ¾Ñ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ', cancelButtonText: 'ĞÑ‚Ğ¼ĞµĞ½Ğ°',
    confirmButtonColor: '#dc2626',
  });
  if (!isConfirmed) return;
  const r = await fetch(`/api/devices/${selId}`, { method: 'DELETE' });
  if (r.ok) { closePanel(); await load(); }
}

/* â”€â”€â”€ Family access / shares â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function showShares() {
  const d = devices.find(x => x.id === selId);
  if (!d) return;

  // Load current shares
  let shares = [];
  try {
    const r = await fetch(`/api/devices/${selId}/shares`);
    if (r.ok) shares = await r.json();
  } catch {}

  const shareHtml = shares.length === 0
    ? '<div style="color:var(--muted);font-size:13px;text-align:center;padding:10px 0;">Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ½Ğµ Ğ²Ñ‹Ğ´Ğ°Ğ½</div>'
    : shares.map(s => `
      <div class="share-user-row">
        <div class="share-user-avatar">${s.username[0].toUpperCase()}</div>
        <div class="share-user-name">${escHtml(s.username)}</div>
        <div class="share-role-badge ${s.role === 'full' ? 'role-full' : 'role-viewer'}">
          ${s.role === 'full' ? 'ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹' : 'ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€'}
        </div>
        <button class="revoke-btn" onclick="revokeShare(${s.user_id})" title="ĞÑ‚Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ">âœ•</button>
      </div>`).join('');

  await Swal.fire({
    title: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿',
    html: `
      <div style="text-align:left; font-size:13px; color:var(--muted); margin-bottom:14px;">
        ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ¾Ğ¼ Ğº ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ñƒ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸ Alidux.
      </div>
      <div id="shares-list" style="margin-bottom:18px;">${shareHtml}</div>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <input id="share-username" type="text" placeholder="Ğ›Ğ¾Ğ³Ğ¸Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"
          style="width:100%; padding:11px 14px; border:1.5px solid #e0e7ff; border-radius:11px;
                 font-size:14px; outline:none; font-family:inherit; background:#f5f8ff;"
          onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e0e7ff'">
        <div style="display:flex; gap:8px; justify-content:center;">
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:13px;">
            <input type="radio" name="share-role" value="viewer" checked> ğŸ‘ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:13px;">
            <input type="radio" name="share-role" value="full"> âœï¸ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
          </label>
        </div>
      </div>`,
    showCancelButton: true,
    confirmButtonText: 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿',
    cancelButtonText: 'Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ',
    confirmButtonColor: '#2563eb',
    preConfirm: () => {
      const uname = document.getElementById('share-username').value.trim();
      const role  = document.querySelector('input[name="share-role"]:checked')?.value || 'viewer';
      if (!uname) { Swal.showValidationMessage('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ'); return false; }
      return { username: uname, role };
    },
  }).then(async ({ isConfirmed, value }) => {
    if (!isConfirmed || !value) return;
    try {
      const r = await fetch(`/api/devices/${selId}/share`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(value),
      });
      if (r.ok) {
        showToast('ok', 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ²Ñ‹Ğ´Ğ°Ğ½', `${value.username} Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿`);
      } else {
        const err = await r.json().catch(() => ({}));
        showToast('warn', 'ĞÑˆĞ¸Ğ±ĞºĞ°', err.detail || 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿');
      }
    } catch { showToast('warn', 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸', ''); }
  });
}

async function revokeShare(userId) {
  const { isConfirmed } = await Swal.fire({
    title: 'ĞÑ‚Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿?', icon: 'warning',
    showCancelButton: true, confirmButtonText: 'Ğ”Ğ°',
    cancelButtonText: 'ĞÑ‚Ğ¼ĞµĞ½Ğ°', confirmButtonColor: '#dc2626',
  });
  if (!isConfirmed) return;
  await fetch(`/api/devices/${selId}/shares/${userId}`, { method: 'DELETE' });
  showToast('ok', 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¾Ñ‚Ğ¾Ğ·Ğ²Ğ°Ğ½', '');
  Swal.close();
}

/* â”€â”€â”€ Add device (claim code flow) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function showAdd() {
  // Generate claim code
  let codeData = null;
  try {
    const r = await fetch('/api/generate-claim-code', { method: 'POST' });
    if (r.ok) codeData = await r.json();
  } catch {}

  if (!codeData) {
    showToast('warn', 'ĞÑˆĞ¸Ğ±ĞºĞ°', 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ¸');
    return;
  }

  const digits = codeData.code.split('');
  const expiresAt = new Date(codeData.expires_at + 'Z');

  let timerInterval;

  await Swal.fire({
    title: 'ğŸ”— Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾',
    html: `
      <div style="font-size:13px; color:var(--muted); text-align:center; margin-bottom:16px;">
        Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾Ñ‚ 4-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ½Ğ° Ğ²Ğ°ÑˆĞµĞ¼ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğµ (Ñ‡ĞµÑ€ĞµĞ· Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ»Ğ¸ Ñ„Ğ¸Ğ·Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸).
      </div>
      <div style="display:flex; justify-content:center; gap:10px; margin:16px 0;">
        ${digits.map(d => `
          <div style="width:56px; height:68px; border-radius:14px;
            background:var(--blue-bg); border:2px solid var(--blue-l);
            display:flex; align-items:center; justify-content:center;
            font-size:34px; font-weight:900; color:var(--blue);
            font-family:'Courier New',monospace;
            box-shadow:0 4px 14px rgba(37,99,235,.15);">
            ${escHtml(d)}
          </div>`).join('')}
      </div>
      <div id="code-timer" style="text-align:center; font-size:12px; color:var(--muted); font-weight:600; margin-bottom:4px;"></div>
      <div style="margin-top:16px; padding:12px 14px; background:#f0fdf4; border-radius:11px;
        border:1px solid #bbf7d0; font-size:12px; color:#15803d; font-weight:600;">
        ğŸ’¡ ĞŸĞ¾ÑĞ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ° ĞºĞ¾Ğ´Ğ° ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.
        Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 4 ÑĞµĞºÑƒĞ½Ğ´Ñ‹.
      </div>`,
    showCancelButton: true,
    showConfirmButton: false,
    cancelButtonText: 'Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ',
    didOpen: () => {
      timerInterval = setInterval(() => {
        const remaining = Math.max(0, Math.ceil((expiresAt - Date.now()) / 1000));
        const el = document.getElementById('code-timer');
        if (!el) return;
        const m = Math.floor(remaining / 60);
        const s = remaining % 60;
        el.textContent = `â± Ğ”ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚ ĞµÑ‰Ñ‘: ${m}:${String(s).padStart(2,'0')}`;
        if (remaining <= 30) el.style.color = 'var(--red)';
        if (remaining <= 0) { el.textContent = 'â° ĞšĞ¾Ğ´ Ğ¸ÑÑ‚Ñ‘Ğº. Ğ—Ğ°ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.'; clearInterval(timerInterval); }
      }, 500);
    },
    willClose: () => clearInterval(timerInterval),
  });
}

/* â”€â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
load();
setInterval(load, 4000);
</script>
</body>
</html>